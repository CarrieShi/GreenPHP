function changeURLPar(destiny, par, par_value){
	var pattern = par+'=([^&]*)';
	var replaceText = par+'='+par_value;
	if (destiny.match(pattern)){
		var tmp = '/\\'+par+'=[^&]*/';
		tmp = destiny.replace(eval(tmp), replaceText);
		return (tmp);
	}else{ 
		if (destiny.match('[\?]')){
			return destiny+'&'+ replaceText;
		}else{
			return destiny+'?'+replaceText;
		}
	}
	return destiny+'\n'+par+'\n'+par_value;
}

function getQueryString(name){
	var uri = window.location.search.substr(1).split('&');
	var param = [];
	for(var i in uri){
		var r = uri[i].split('=');
		param[r[0]]? param[r[0]].push(r[1]) : param[r[0]] = [r[1]];
	}
	if(param[name]) return param[name].length>1? param[name] : param[name][0];
	return '';
}

$('.PrevPage').click(function(){
	var page = parseInt(getQueryString('page'));
	if(isNaN(page) || page <= 1) page = 1;
	page -= 1;
	window.location.href = changeURLPar(window.location.href,'page',page);
});

$('.NextPage').click(function(){
	var page = parseInt(getQueryString('page'));
	if(isNaN(page)) page = 1;
	page += 1;
	window.location.href = changeURLPar(window.location.href,'page',page);
});

if($('.datetime').length){
	$('.datetime').datetimepicker({
		format: 'yyyy-mm-dd hh:ii',
		language:'zh-CN',
		weekStart: 1,
		todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		minView:0,
		showMeridian: 1
	});
}

var mainTopMargin = 0;
$(window).bind("scroll", function(){ 
        mainTopMargin = $(this).scrollTop();//当前窗口的滚动距离
});
function status(type,msg,time,callback){
	if(typeof(time) == 'undefined') time = 4000;
	if($('.act-msg').length > 0){
		$('.act-msg').remove();
	}
	if(mainTopMargin > 0){
		$('body').prepend('<div class="act-msg text-'+type+'" style="top:'+mainTopMargin+'px">'+msg+'</div>');
	}else{
		$('body').prepend('<div class="act-msg text-'+type+'">'+msg+'</div>');
	}
	$('.act-msg').fadeIn('slow',function(){
		setTimeout(function(){
			$('.act-msg').fadeOut('slow',function(){
				$('.act-msg').remove();
				if(typeof(callback) != 'undefined'){
					callback();
				}
			});
		},time);
	});
}

function reqbtn(obj){
	this.timer;
	var that = this;
	this.submitStatus = function(){
		if(typeof($(obj).html()) != 'undefined'){
			if(typeof($(obj).attr('btnval')) == 'undefined'){
				$(obj).attr('btnval',$(obj).html());
				$(obj).attr('disabled','disabled');
				$(obj).addClass('disabled');
				$(obj).html('请求中 请稍候');
				$(obj).css('width','140px');
				$(obj).css('text-align','left');
				$(obj).css('font-weight','bold');
				that.timer = setInterval(function(){
					var btnval = $(obj).html();
					if((btnval.split('.')).length-1 >= 3){
						$(obj).html('请求中 请稍候');
					}else{
						$(obj).html($(obj).html()+'.');
					}
				},250);
			}else{
				clearInterval(that.timer);
				$(obj).html($(obj).attr('btnval'));
				$(obj).removeAttr('btnval');
				$(obj).css('width','auto');
				$(obj).css('text-align','center');
				$(obj).css('font-weight','normal');
				$(obj).removeAttr('disabled');
				$(obj).removeClass('disabled');
			}
		}else{
			if(typeof($(obj).attr('btnval')) == 'undefined'){
				$(obj).attr('btnval',$(obj).val());
				$(obj).attr('disabled','disabled');
				$(obj).addClass('disabled');
				$(obj).val('请求中 请稍候');
				$(obj).css('width','140px');
				$(obj).css('text-align','left');
				$(obj).css('font-weight','bold');
				that.timer = setInterval(function(){
					var btnval = $(obj).val();
					if((btnval.split('.')).length-1 >= 3){
						$(obj).val('请求中 请稍候');
					}else{
						$(obj).val($(obj).html()+'.');
					}
				},250);
			}else{
				clearInterval(that.timer);
				$(obj).val($(obj).attr('btnval'));
				$(obj).removeAttr('btnval');
				$(obj).css('width','auto');
				$(obj).css('text-align','center');
				$(obj).css('font-weight','normal');
				$(obj).removeAttr('disabled');
				$(obj).removeClass('disabled');
			}
		}
	}
}


function request(obj,back,cb){
	if(typeof(back) == 'undefined') back = window.location.href;//false;
	var url = $(obj).action? $(obj).action : window.location.href;
	var post = $(obj).serialize()? $(obj).serialize() : null;
	$.post(url,post,function (data){
		var btn = new reqbtn($(obj).find(':submit'));
		btn.submitStatus();
		status('info','请求中，请稍候...',36000);
		try{
			var json = eval('('+data+')');
		}catch(JSONException){
			status('error',data,36000);
		}
		if(back && json.code=='success'){
			status(json.code,json.desc,2000,function(){
				if(back){
					window.location.href = back;
					return ;
				}
				btn.submitStatus();
			});
		}else{
			status(json.code,json.desc,4000,function(){
				btn.submitStatus();
			});
		}
		if(typeof(cb) != 'undefined'){
			cb(data);
		}
	});
	return false;
}

//添加debug调试信息
function debugshow(data){
    var json = eval('('+data+')');
    if($("#debug_mode").is(":checked")){
		$("#debug_info").text("debug: "+json.debug); 
	  }	
}